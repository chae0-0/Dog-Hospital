<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì›ë¬´/ì ‘ìˆ˜ ë°ìŠ¤í¬</title>
    <style>
        :root {
            --primary: #2d3436;
            --border: #b2bec3;
            --bg-color: #f5f6fa;
        }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg-color); padding: 30px; margin: 0; color: #222; }
        .container { max-width: 1200px; margin: 0 auto; }

        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #dcdcdc; }
        header h1 { margin: 0; font-size: 26px; color: var(--primary); font-weight: 800; letter-spacing: -0.5px; }
        .btn-home { text-decoration: none; font-size: 14px; color: #636e72; background: white; padding: 10px 20px; border: 1px solid #b2bec3; transition: 0.2s; font-weight: 700; border-radius: 4px; }
        .btn-home:hover { background: #2d3436; color: white; border-color: #2d3436; }

        .section-box { background: white; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; margin-bottom: 30px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .section-header { padding: 15px 25px; border-bottom: 1px solid var(--border); background: #fdfdfd; font-size: 16px; font-weight: 800; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }

        .search-inner { padding: 25px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .search-input { width: 350px; padding: 12px 16px; border: 2px solid #dfe6e9; font-size: 15px; outline: none; background-color: #fff; transition: 0.2s; font-weight: 600; border-radius: 4px; }
        .search-input:focus { border-color: #2d3436; }
        .btn-search { background-color: #2d3436; color: white; border: none; padding: 12px 24px; font-size: 15px; cursor: pointer; font-weight: 700; border-radius: 4px; transition: 0.2s; }
        .btn-new { background-color: white; color: #2d3436; border: 2px solid #2d3436; padding: 10px 20px; text-decoration: none; font-size: 15px; font-weight: 700; transition: 0.2s; border-radius: 4px; }
        .btn-new:hover { background-color: #f1f2f6; }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f1f2f6; text-align: left; padding: 14px 20px; border-bottom: 2px solid var(--border); color: #555; font-weight: 800; }
        td { padding: 14px 20px; border-bottom: 1px solid #e1e1e1; color: #2d3436; font-weight: 600; }

        .btn-sm { padding: 6px 12px; font-size: 12px; border: 1px solid #b2bec3; background: white; cursor: pointer; color: #636e72; transition: 0.2s; font-weight: 700; border-radius: 4px; }
        .btn-sm:hover { background: #636e72; color: white; border-color: #636e72; }

        .btn-reserve { background-color: #2980b9; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 700; font-size: 12px; margin-right: 5px; }
        .btn-reserve:hover { background-color: #1f618d; }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 800; color: white; display: inline-block; text-align: center; min-width: 60px; }
        .badge-reserved { background-color: #273c75; }
        .badge-waiting { background-color: #dfe6e9; color: #2d3436; border: 1px solid #b2bec3; }
        .badge-inprogress { background-color: #c0392b; }
        .badge-completed { background-color: #2d3436; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-window { background: white; width: 600px; border-radius: 8px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); display: flex; flex-direction: column; max-height: 85vh; overflow: hidden; }

        .modal-header { padding: 20px 25px; border-bottom: 2px solid #f1f2f6; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .modal-title { font-size: 18px; font-weight: 800; color: #2d3436; }
        .btn-close { background: none; border: none; font-size: 28px; color: #b2bec3; cursor: pointer; line-height: 1; font-weight: bold; }

        .modal-body { padding: 0; overflow-y: auto; background-color: #fcfcfc; flex: 1; }

        .history-item { padding: 20px 25px; border-bottom: 1px solid #eee; background: white; }
        .history-date { font-size: 14px; color: #636e72; font-weight: 700; margin-bottom: 5px; }
        .history-section { margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px; border: 1px solid #eee; }
        .history-section-title { font-size: 12px; font-weight: 800; color: #2980b9; margin-bottom: 4px; }
        .history-text { font-size: 13px; color: #333; margin-bottom: 2px; }

        .reserve-form-row { margin-bottom: 15px; padding: 0 25px; }
        .reserve-form-row label { display: block; font-size: 13px; font-weight: 700; color: #555; margin-bottom: 5px; }
        .reserve-form-row input, .reserve-form-row select, .reserve-form-row textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-submit-reserve { width: 100%; padding: 15px; background: #2c3e50; color: white; border: none; font-size: 15px; font-weight: 700; cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>ì›ë¬´/ì ‘ìˆ˜ ë°ìŠ¤í¬</h1>
        <a href="{% url 'dashboard' %}" class="btn-home">ë©”ì¸ í™”ë©´</a>
    </header>

    <div class="section-box">
        <div class="section-header">
            <span>ğŸ“… ì˜¤ëŠ˜ì˜ ì˜ˆì•½ ìŠ¤ì¼€ì¤„ ({{ today_appointments.count }}ê±´)</span>
        </div>
        <table>
            <thead>
                <tr>
                    <th style="width: 20%;">ì‹œê°„</th>
                    <th style="width: 25%;">í™˜ìëª…</th>
                    <th style="width: 25%;">ë³´í˜¸ì</th>
                    <th style="width: 15%;">ë‹´ë‹¹ ìˆ˜ì˜ì‚¬</th>
                    <th style="width: 15%;">ìƒíƒœ</th>
                </tr>
            </thead>
            <tbody>
                {% for appt in today_appointments %}
                <tr>
                    <td>{{ appt.time|time:"A g:i" }}</td>
                    <td>{{ appt.animal.name }} <span style="font-weight:400; color:#888;">({{ appt.animal.breed }})</span></td>
                    <td>{{ appt.owner.name }}</td>
                    <td>{{ appt.vet.name|default:"-" }}</td>
                    <td>
                        {% if appt.status == 'reserved' %}<span class="badge badge-reserved">ì˜ˆì•½ì¤‘</span>
                        {% elif appt.status == 'waiting' %}<span class="badge badge-waiting">ëŒ€ê¸°ì¤‘</span>
                        {% elif appt.status == 'in_progress' %}<span class="badge badge-inprogress">ì§„ë£Œì¤‘</span>
                        {% elif appt.status == 'completed' %}<span class="badge badge-completed">ì™„ë£Œ</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="5" style="text-align:center; padding: 40px; color:#b2bec3;">ì˜¤ëŠ˜ ì˜ˆì •ëœ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="section-box">
        <div class="section-header">í™˜ì ì¡°íšŒ ë° ì˜ˆì•½</div>

        <div class="search-inner">
            <form method="get" style="display: flex; gap: 10px; align-items: center;">
                <input type="text" name="q" class="search-input" placeholder="ì´ë¦„ ë˜ëŠ” ì „í™”ë²ˆí˜¸ ê²€ìƒ‰" value="{{ request.GET.q|default:'' }}">
                <button type="submit" class="btn-search">ì¡°íšŒ</button>
            </form>
            <div style="width: 1px; height: 20px; background: #ddd; margin: 0 10px;"></div>
            <a href="{% url 'register_new_patient' %}" class="btn-new">+ ì‹ ê·œ í™˜ì ë“±ë¡</a>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 20%;">ë³´í˜¸ì</th>
                    <th style="width: 25%;">ì—°ë½ì²˜</th>
                    <th>í™˜ì ì •ë³´</th>
                    <th style="width: 20%;">ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>
                {% for owner in search_results %}
                    {% for animal in owner.animals.all %}
                    <tr>
                        <td>{{ owner.name }}</td>
                        <td>{{ owner.phone }}</td>
                        <td>
                            <span style="font-weight: 800; font-size: 16px;">{{ animal.name }}</span>
                            <span style="color:#888; font-size:13px; margin-left: 6px; font-weight: 600;">({{ animal.breed }})</span>
                        </td>
                        <td>
                            <button class="btn-reserve" onclick="openReserveModal('{{ animal.id }}', '{{ animal.name }}', '{{ owner.id }}')">ì˜ˆì•½ ì¡ê¸°</button>
                            <button class="btn-sm" onclick="openHistoryModal('history-{{ animal.id }}')">ê¸°ë¡ ë³´ê¸°</button>
                        </td>
                    </tr>

                    <div id="history-{{ animal.id }}" class="modal-overlay">
                        <div class="modal-window">
                            <div class="modal-header">
                                <span class="modal-title">{{ animal.name }} ìƒì„¸ ì§„ë£Œ ê¸°ë¡</span>
                                <button class="btn-close" onclick="closeModal('history-{{ animal.id }}')">&times;</button>
                            </div>
                            <div class="modal-body">
                                {% for appt in animal.appointment_set.all|dictsortreversed:"date" %}
                                    <div class="history-item">
                                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                            <span class="history-date">{{ appt.date }} ({{ appt.get_status_display }})</span>
                                            <span style="font-size:12px; color:#888;">ë‹´ë‹¹: {{ appt.vet.name }}</span>
                                        </div>

                                        {% if appt.medical_record %}
                                            <div style="font-size:15px; font-weight:800; color:#2d3436; margin-bottom:5px;">
                                                ì§„ë‹¨: {{ appt.medical_record.diagnosis }}
                                            </div>
                                            {% if appt.medical_record.symptom %}
                                            <div style="margin-top:8px; font-size:13px; color:#555;">
                                                <span style="font-weight:bold;">ì¦ìƒ/ë©”ëª¨:</span> {{ appt.medical_record.symptom }}
                                            </div>
                                            {% endif %}
                                        {% else %}
                                            <div style="color:#aaa; font-size:13px;">ì§„ë£Œ ê¸°ë¡ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>
                                        {% endif %}
                                    </div>
                                {% empty %}
                                    <div style="padding: 40px; text-align: center; color: #b2bec3;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% empty %}
                <tr><td colspan="4" style="text-align:center; padding: 50px; color:#b2bec3;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="reserveModal" class="modal-overlay">
    <div class="modal-window" style="width: 450px;">
        <div class="modal-header">
            <span class="modal-title">ì‹ ê·œ ì˜ˆì•½ ë“±ë¡</span>
            <button class="btn-close" onclick="closeReserveModal()">&times;</button>
        </div>
        <div class="modal-body" style="padding-top: 20px;">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="create_appt">
                <input type="hidden" id="modal_animal" name="animal">
                <input type="hidden" id="modal_owner" name="owner">

                <div class="reserve-form-row">
                    <label>í™˜ìëª…</label>
                    <input type="text" id="modal_animal_name" disabled style="background:#f0f0f0;">
                </div>

                <div class="reserve-form-row">
                    <label>ë‹´ë‹¹ ìˆ˜ì˜ì‚¬</label>
                    {{ appointment_form.vet }}
                </div>

                <div class="reserve-form-row">
                    <label>ì˜ˆì•½ ë‚ ì§œ</label>
                    {{ appointment_form.date }}
                </div>

                <div class="reserve-form-row">
                    <label>ì˜ˆì•½ ì‹œê°„</label>
                    {{ appointment_form.time }}
                </div>

                <div class="reserve-form-row">
                    <label>ë‚´ì› ì‚¬ìœ </label>
                    {{ appointment_form.reason }}
                </div>

                <button type="submit" class="btn-submit-reserve">ì˜ˆì•½ ì €ì¥</button>
            </form>
        </div>
    </div>
</div>

<script>
    function openHistoryModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function openReserveModal(animalId, animalName, ownerId) {
        document.getElementById('reserveModal').style.display = 'flex';
        document.getElementById('modal_animal').value = animalId;
        document.getElementById('modal_owner').value = ownerId;
        document.getElementById('modal_animal_name').value = animalName;
    }
    function closeReserveModal() { document.getElementById('reserveModal').style.display = 'none'; }
    window.onclick = function(e) { if(e.target.classList.contains('modal-overlay')) e.target.style.display = 'none'; }
</script>
</body>
</html>